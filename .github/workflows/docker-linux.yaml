name: Linux container

on:
  push:
  pull_request:
    branches: [ "main" ]

jobs:
  docker:
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        CONTAINER: [
          almalinux:latest,
          alpine:3.17,
          alpine:3.17.7,
          alpine:3.18,
          alpine:3.18.6,
          alpine:3.19,
          alpine:3.19.1,
          amazonlinux:latest,
          archlinux:latest,
          clearlinux:latest,
          debian:12-slim,
          debian:testing-slim,
          debian:unstable-slim,
          devuan/devuan:latest,
          fedora:38,
          fedora:39,
          fedora:40,
          fedora:41,
          opensuse/tumbleweed,
          oraclelinux:9,
          rockylinux:9,
          rockylinux:9.3,
          ubuntu:22.04,
          ubuntu:24.04,
          ubuntu:24.10,
        ]
        CC: [clang, gcc]
        ASM: [asm=no, asm=yes]
      fail-fast: false
    container: ${{ matrix.CONTAINER }}
    steps:
    - name: amazonlinux: Install tar gzip
      if: startsWith(matrix.CONTAINER, 'amazonlinux:')
      run: dnf install -qy tar gzip

    - uses: actions/checkout@v4

    - name: Install dependencies
      run: misc/install-deps.sh ${{ matrix.CONTAINER }}

    - name: Build libraries
      run: |
        autoreconf -fi
        ./configure --disable-silent-rules --enable-shared --enable-static --enable-${{ matrix.ASM }} CC=${{ matrix.CC }}
        make

    - name: Build examples
      run: make examples

    - name: Run examples
      run: make examples-run

    - name: Examine build artifacts
      run: ls -lh .libs/*.so* && sha256sum .libs/*.so
